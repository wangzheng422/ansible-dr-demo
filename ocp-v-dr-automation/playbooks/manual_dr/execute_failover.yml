---
- name: Execute Full DR Failover Workflow
  hosts: localhost
  gather_facts: false
  connection: local

  vars_prompt:
    - name: backup_name
      prompt: "Enter the OADP backup name to restore (leave empty to use the latest)"
      private: no
      default: "{{ default_backup_name }}"

  tasks:
    # ----------------------------------------------------------------
    # Block 1: Pre-Failover Actions on Primary Site (Optional)
    # ----------------------------------------------------------------
    - name: Pre-Failover Actions
      block:
        - name: Shut down VMs on Primary OCP (Placeholder)
          debug:
            msg: "TASK: Shutting down VMs on the primary cluster. Implementation needed."

        - name: Set Primary Storage to Read-Only (Placeholder)
          debug:
            msg: "TASK: Setting primary NFS storage to read-only. Implementation needed."

        - name: Verify Final Data Sync Status (Placeholder)
          debug:
            msg: "TASK: Running final data consistency check. Implementation needed."
      when: false # Disabled by default for safety, enable when tasks are implemented

    # ----------------------------------------------------------------
    # Block 2: Parse OADP Backup
    # ----------------------------------------------------------------
    - name: Parse OADP Backup to get PV and PVC definitions
      include_role:
        name: oadp_backup_parser
      register: backup_data

    # ----------------------------------------------------------------
    # Block 3: Provision Storage on DR Site
    # ----------------------------------------------------------------
    - name: Provision Storage on DR Cluster
      include_role:
        name: dr_storage_provisioner
      vars:
        pv_info_list: "{{ backup_data.pv_info_list }}"
        pvc_info_list: "{{ backup_data.pvc_info_list }}"
      when: backup_data.pv_info_list is defined and backup_data.pvc_info_list is defined

    # ----------------------------------------------------------------
    # Block 4: Trigger OADP Restore on DR Site
    # ----------------------------------------------------------------
    - name: Trigger OADP Restore on DR Cluster
      include_role:
        name: oadp_restore_trigger
      vars:
        oadp_backup_name: "{{ backup_name }}"

    # ----------------------------------------------------------------
    # Block 5: Post-Failover Verification and Cleanup
    # ----------------------------------------------------------------
    - name: Post-Failover Actions
      block:
        - name: Verify VM Status on DR Cluster (Placeholder)
          debug:
            msg: "TASK: Verifying that VMs are running on the DR cluster. Implementation needed."

        - name: Clean up temporary files
          file:
            path: "{{ backup_data.temp_backup_dir }}"
            state: absent
          when: backup_data.temp_backup_dir is defined

        - name: Generate Failover Report (Placeholder)
          debug:
            msg: "TASK: Generating failover report. Implementation needed."
